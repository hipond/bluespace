gh={host:"",cdnPublicRoot:"",cdnImgRoot:"",uniqid:0,kvMap:{},regex:{}},gh.regex.username=/^[\w\u4e00-\u9fa5]{3,24}$/,gh.regex.email=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,gh.regex.password=/^\w{8,32}$/,gh.regex.title=/^.{1,256}$/,gh.fieldRuleMap={username:function(e){return gh.regex.username.test(e)?/(^\_)|(\__)|(\_+$)/.test(e)?"用户名首尾不能出现下划线'_'":/^\d+\d+\d$/.test(e)?"用户名不能全为数字":void 0:"用户名不能有特殊字符"},password:function(e){if(!gh.regex.password.test(e))return"密码必须8到24位数字或字母"},email:function(e){if(!gh.regex.email.test(e))return"邮箱格式有误"},logined:function(){if(!gh.logined)return gh.alert("请登录"),setTimeout(function(){location=gh.path("/passport/login?from=topic.comment")},800),!1}},gh.path=function(e){return/^http[s]*:\/\//i.test(e)?e:gh.host+e},gh.cdn=function(e){return gh.cdnPublicRoot+e},gh.alert=function(e,t,n,a){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future"};a=1==a||"success"==a?"success":"error";Messenger().post({message:e,type:a,showCloseButton:!1,id:"gh-alert",hideAfter:t||1.3,onClickClose:!0}),0<t&&setTimeout(function(){"string"!=typeof n?n():window.location=n},t)},gh.confirm=function(e,t){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future",id:"gh-confirm"};var n=Messenger().post({message:e,type:"error",actions:{confirm:{label:"确定",action:function(){return n.cancel(),t()}},cancel:{label:"取消",action:function(){return n.cancel()}}}})},gh.run=function(e,t){if(gh.runHub=gh.runHub||{},gh.runId=gh.runId||0,void 0!==e)id=++gh.runId,void 0===t&&(t=e,e=id),gh.runHub[id]={key:e,fn:t};else for(var n=0;n++<=gh.runId;)"object"==typeof gh.runHub[n]&&gh.runHub[n].fn()},gh.fn=function(e,t){return gh.fnHub=gh.fnHub||{},"function"==typeof t?gh.fnHub[e]=t:gh.fnHub[e](t)},gh.log=function(){gh.debug=gh.debug||!1,gh.debug&&console.log(arguments)},gh.data=function(e){var s="string"==typeof e?$(e):e,u={},d=0;if(s.find("input").not("[type=file]").each(function(){if(!d){var e=$(this),t=e.attr("name"),a=e.attr("title")||e.siblings("label").text()||e.attr("name"),o=e.val(),n=e.attr("required"),i=e.attr("exp"),r=e.attr("equal");if(n&&o.length<1)return gh.alert("请填写`"+a+"`"),d++;if(i){i=i.split("|");var c=!1,l=!1;if($.each(i,function(e,t){if(fn=gh.fieldRuleMap[t])(l=fn(o))||(c=!0);else{var n=gh.regex[t];n||gh.alert("规则配置异常："+a+":"+t),n.test(o)&&(c=!0)}}),!c)return gh.alert(l||"`"+a+"`格式有误"),d++}if(r)if((s.find("input[name="+r+"]").val()||null)!=o)return gh.alert("`"+a+"`不匹配"),d++;u[t]=o}}),!d&&(s.find(".radio.checked").each(function(){var e=$(this),t=e.attr("name");u[t]=e.val()||e.attr("value")}),s.find(".src").each(function(){var e=$(this),t=e.attr("name");u[t]=e.val()||e.attr("src")}),s.find(".textarea").each(function(){if(!d){var e=$(this),t=e.attr("name");if(e.hasClass("editor")){var n=e.attr("editor")||null;if(!n)return gh.alert("error.editor.id"),d++;var a=gh.kvMap[n]||null;if(!a)return gh.alert("error.editor.object"),d++;if(a.getLength()<3)return gh.alert("内容字数过少，请完善内容"),d++;u[t]=a.root.innerHTML}else u[t]=e.val()}}),!d))return u},gh.post=function(e,t,n,a){$.post(gh.path(e),t,function(t){if(1===t.state){var e=t.data.timeout||e||1500;gh.alert(t.message,e,function(){var e=e||t.data.location;e&&"#"!=e&&("."==e&&(e=location),window.location=e)},"success")}else gh.alert(t.message)},"json")},gh.runPostFlow=function(o){if(o.hasClass("off"))return!1;function e(){var e=o.attr("api");e||gh.alert("error.btn.api");var t=o.hasClass("empty")?{}:gh.data(o.closest(".form")),n=o.attr("timeout")||1500,a=o.attr("redirect")||null;return t&&gh.post(e,t,n,a),!1}o.addClass("off"),setTimeout(function(){o.removeClass("off")},3e3);var t=o.attr("confirm");return t?gh.confirm(t,function(){e()}):e()},gh.load=function(e,t,n){return gh.loadMap=gh.loadMap||{},1===gh.loadMap[e]?t():(n=$.extend(n||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(n).done(function(){return gh.loadMap[e]=1,t()}))},gh.fn("editor",function(n){var e=$(n.element);e.after("<input class='upload image hide' type='file' name='file'/>");var a=e.next("input.upload.image"),o=new Quill(n.element,{placeholder:"正文内容...",modules:{toolbar:[{header:1},{header:2},{color:["#ab2b2b","#069","#337d56","#9d5b8b","#dcb183","#f0f0f0","#000"]},"bold","italic","underline",{align:[]},"image",{list:"ordered"},{list:"bullet"},{script:"sub"},{script:"super"},"code-block","clean"],uploader:!1},theme:"snow"});function i(e){if(!e){if(""==a.val())return void gh.log("fileInput:empty");e=a.get(0).files[0]}var t=new FormData;t.append("signature",n.signature),t.append("policy",n.policy),t.append("file",e),gh.log(t),$.ajax({url:n.url,data:t,type:"POST",async:!1,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){var t=gh.cdnImgRoot+e.url+"!content",n=o.getSelection(),a=0+(null===n?0:n.index);o.insertEmbed(a,"image",t),o.setSelection(1+a)},error:function(e){gh.log(e)}})}o.getModule("toolbar").addHandler("image",function(e){e?a.click():o.format("image",!1)}),o.root.addEventListener("paste",function(e){e.preventDefault(),e.clipboardData&&e.clipboardData.files&&e.clipboardData.files.length&&$.each(e.clipboardData.files,function(e,t){t.type.match(/^image\/(gif|jpe?g|a?png|bmp)/i)?i(t):cosole.log(t)})},!1),o.root.addEventListener("drop",function(e){if(e.preventDefault(),e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length){if(document.caretRangeFromPoint){var t=document.getSelection(),n=document.caretRangeFromPoint(e.clientX,e.clientY);t&&n&&t.setBaseAndExtent(n.startContainer,n.startOffset,n.startContainer,n.startOffset)}$.each(e.dataTransfer.files,function(e,t){t.type.match(/^image\/(gif|jpe?g|a?png|bmp)/i)&&i(t)})}return e.dataTransfer.clearData(),!1},!1),a.on("change",function(){i()});var t=++gh.uniqid;return e.attr("editor",t),gh.kvMap[t]=o}),gh.fn("imageUploader",function(t){var n=$(t.element);n.after("<input class='upload image hide' type='file' name='file'/>");var a=n.next("input.upload.image");n.on("click",function(){a.click()}),a.on("change",function(){!function(){if(""==a.val())gh.log("fileInput:empty");else{var e=new FormData;e.append("signature",t.signature),e.append("policy",t.policy),e.append("file",a.get(0).files[0]),gh.log(e),$.ajax({url:t.url,data:e,type:"POST",async:!1,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){var t=gh.cdnImgRoot+e.url+"!content";n.attr("src",t)},error:function(e){gh.log(e)}})}}()})}),gh.run("com.common",function(){$(".zone.breadcrumb a").not(":first").before("|"),$("a[href=]").removeAttr("href"),$(".body.main").css({"min-height":$(window).height()-160}),$(".super").each(function(){$(this).appendTo("body")}),$(".popup[inline]").each(function(){var e=$(this);e.hasClass("logined")&&!gh.logined||e.modaal({type:"inline",overlay_close:!1,content_source:e.attr("inline"),fullscreen:!!e.attr("fullscreen"),width:700<$(window).width()?700:null,close_text:"关闭"})}),$("img").error(function(){$(this).hide()}),"/"==location.pathname&&$(".zone.breadcrumb *").css({cursor:"auto"})}),gh.run("com.tab",function(){$(".tab").each(function(){var e=$(this),t=e.children(".head").first(),n=e.children(".content").first(),a=t.children(".key"),o=n.children(".item");a.each(function(){var e=$(this),t=e.index();e.on("click",function(){a.removeClass("focus"),e.addClass("focus"),o.removeClass("on"),o.eq(t).addClass("on")})})}),$(".switch[rel]").on("click",function(e){$(".zone.optional.region.menu .tab.province .content").css({"min-height":"auto"}),e.preventDefault();var t=$(this).attr("rel"),n=$(".zone.optional"),a=$(".zone.optional."+t);return n.not(a).hide(),a.slideToggle(),!1}),$(document).bind("click",function(e){0==$(e.target).closest(".zone.optional").length&&0==$(e.target).closest(".switch[rel]").length&&$(".zone.optional").slideUp()})}),gh.run("com.form",function(){$("input[type=hidden]").addClass("hidden"),$("input").not("[type=hidden]").addClass("input"),$(".radio").each(function(){var e=$(this),t=e.siblings(".radio");e.parent().children(".radio").first().addClass("first"),e.on("click",function(){t.removeClass("checked"),e.addClass("checked")})}),$(".topic .content img,.comment .content img").each(function(){var e=$(this);e.closest("p").addClass("img");var t="<a href='"+e.attr("src")+"' data-lightbox='one'></a>";e.wrap(t)});var e=function(){$(".input").each(function(){var e=$(this),t=e.closest(".body.main"),n=t.children("label,.label").first().width()||150,a=t.width()-n-50;e.width(a)})};e(),$(window).resize(function(){gh.log("window.resized"),e()}),$(".btn[api],.icon[api]").each(function(){var e=$(this);e.on("click",function(){return gh.runPostFlow(e)})})}),gh.run("com.debug",function(){if(gh.debug){var e=null,t="ws://127.0.0.1:9502";window.onload=function(){console.log("onload"),(e=new WebSocket(t)).onopen=function(){console.log("connected to "+t)},e.onclose=function(e){console.log("connection closed ("+e.code+")")},e.onmessage=function(e){console.log("message received: "+e.data),"reload"==e.data&&(location=location)}}}});
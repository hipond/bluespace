gh={host:"",cdnHost:"",uniqid:0,kvMap:{},regex:{}},gh.regex.username=/^[\w\u4e00-\u9fa5]{3,24}$/,gh.regex.email=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,gh.regex.password=/^\w{8,32}$/,gh.regex.title=/^.{1,256}$/,gh.fieldRuleMap={username:function(e){return gh.regex.username.test(e)?/(^\_)|(\__)|(\_+$)/.test(e)?"用户名首尾不能出现下划线'_'":/^\d+\d+\d$/.test(e)?"用户名不能全为数字":void 0:"用户名不能有特殊字符"},password:function(e){if(!gh.regex.password.test(e))return"密码必须8到24位数字或字母"},email:function(e){if(!gh.regex.email.test(e))return"邮箱格式有误"},logined:function(){if(!gh.logined)return gh.alert("请登录"),setTimeout(function(){location=gh.path("/passport/login?from=topic.comment")},800),!1}},gh.path=function(e){return/^http[s]*:\/\//i.test(e)?e:gh.host+e},gh.cdn=function(e){return gh.cdnHost+e},gh.alert=function(e,n,t,o){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future"};o=1==o||"success"==o?"success":"error";Messenger().post({message:e,type:o,showCloseButton:!1,id:"gh-alert",hideAfter:n||1.3,onClickClose:!0}),0<n&&setTimeout(function(){"string"!=typeof t?t():window.location=t},n)},gh.confirm=function(e,n){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future",id:"gh-confirm"};var t=Messenger().post({message:e,type:"error",actions:{confirm:{label:"确定",action:function(){return t.cancel(),n()}},cancel:{label:"取消",action:function(){return t.cancel()}}}})},gh.run=function(e,n){if(gh.runHub=gh.runHub||{},gh.runId=gh.runId||0,void 0!==e)id=++gh.runId,void 0===n&&(n=e,e=id),gh.runHub[id]={key:e,fn:n};else for(var t=0;t++<=gh.runId;)"object"==typeof gh.runHub[t]&&gh.runHub[t].fn()},gh.fn=function(e,n){return gh.fnHub=gh.fnHub||{},"function"==typeof n?gh.fnHub[e]=n:gh.fnHub[e](n)},gh.log=function(){gh.debug=gh.debug||!1,gh.debug&&console.log(arguments)},gh.data=function(e){var l="string"==typeof e?$(e):e,u={},h=0;if(l.find("input").not("[type=file]").each(function(){if(!h){var e=$(this),n=e.attr("name"),o=e.attr("title")||e.siblings("label").text()||e.attr("name"),i=e.val(),t=e.attr("required"),a=e.attr("exp"),r=e.attr("equal");if(t&&i.length<1)return gh.alert("请填写`"+o+"`"),h++;if(a){a=a.split("|");var s=!1,c=!1;if($.each(a,function(e,n){if(fn=gh.fieldRuleMap[n])(c=fn(i))||(s=!0);else{var t=gh.regex[n];t||gh.alert("规则配置异常："+o+":"+n),t.test(i)&&(s=!0)}}),!s)return gh.alert(c||"`"+o+"`格式有误"),h++}if(r)if((l.find("input[name="+r+"]").val()||null)!=i)return gh.alert("`"+o+"`不匹配"),h++;u[n]=i}}),!h&&(l.find(".radio.checked").each(function(){var e=$(this),n=e.attr("name");u[n]=e.val()||e.attr("value")}),l.find(".src").each(function(){var e=$(this),n=e.attr("name");u[n]=e.val()||e.attr("src")}),l.find(".textarea").each(function(){if(!h){var e=$(this),n=e.attr("name");if(e.hasClass("editor")){var t=e.attr("editor")||null;if(!t)return gh.alert("error.editor.id"),h++;var o=gh.kvMap[t]||null;if(!o)return gh.alert("error.editor.object"),h++;if(o.sync(),o.getContentTxt().length<3)return gh.alert("内容字数过少，请完善内容"),h++;u[n]=o.getContent()}else u[n]=e.val()}}),!h))return u},gh.post=function(e,n,t,o){$.post(gh.path(e),n,function(n){if(1===n.state){var e=n.data.timeout||e||1500;gh.alert(n.message,e,function(){var e=e||n.data.location;e&&"#"!=e&&("."==e&&(e=location),window.location=e)},"success")}else gh.alert(n.message)},"json")},gh.runPostFlow=function(i){if(i.hasClass("off"))return!1;function e(){var e=i.attr("api");e||gh.alert("error.btn.api");var n=i.hasClass("empty")?{}:gh.data(i.closest(".form")),t=i.attr("timeout")||1500,o=i.attr("redirect")||null;return n&&gh.post(e,n,t,o),!1}i.addClass("off"),setTimeout(function(){i.removeClass("off")},3e3);var n=i.attr("confirm");return n?gh.confirm(n,function(){e()}):e()},gh.load=function(e,n,t){return gh.loadMap=gh.loadMap||{},1===gh.loadMap[e]?n():(t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t).done(function(){return gh.loadMap[e]=1,n()}))},gh.fn("editor",function(e){var n=$("#"+e.element),t=UE.getEditor(e.element);var o=++gh.uniqid;return n.attr("editor",o),gh.kvMap[o]=t}),gh.fn("imageUploader",function(n){var t=$(n.element);t.after("<input class='upload image hide' type='file' name='file'/>");var o=t.next("input.upload.image");t.on("click",function(){o.click()}),o.on("change",function(){!function(){if(""==o.val())gh.log("fileInput:empty");else{var e=new FormData;e.append("signature",n.signature),e.append("policy",n.policy),e.append("file",o.get(0).files[0]),gh.log(e),$.ajax({url:n.url,data:e,type:"POST",async:!1,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){var n=gh.cdn(e.url+"!content");t.attr("src",n)},error:function(e){gh.log(e)}})}}()})}),gh.run("com.common",function(){$(".zone.breadcrumb a").not(":first").before("|"),$("a[href=]").removeAttr("href"),$(".body.main").css({"min-height":$(window).height()-130}),$(".super").each(function(){$(this).appendTo("body")}),$(".popup[inline]").each(function(){var e=$(this);e.hasClass("logined")&&!gh.logined||e.modaal({type:"inline",overlay_close:!1,content_source:e.attr("inline"),fullscreen:!!e.attr("fullscreen"),width:700<$(window).width()?700:null,close_text:"关闭"})}),$("img").error(function(){$(this).hide()}),"/"==location.pathname&&$(".zone.breadcrumb *").css({cursor:"auto"})}),gh.run("com.tab",function(){$(".tab").each(function(){var e=$(this),n=e.children(".head").first(),t=e.children(".content").first(),o=n.children(".key"),i=t.children(".item");o.each(function(){var e=$(this),n=e.index();e.on("click",function(){o.removeClass("focus"),e.addClass("focus"),i.removeClass("on"),i.eq(n).addClass("on")})}),o.eq(0).addClass("focus"),i.eq(0).addClass("on")}),$(".switch[rel]").on("click",function(e){$(".zone.optional.region.menu .tab.province .content").css({"min-height":"auto"}),e.preventDefault();var n=$(this).attr("rel"),t=$(".zone.optional"),o=$(".zone.optional."+n);return t.not(o).hide(),o.slideToggle(),!1}),$(document).bind("click",function(e){0==$(e.target).closest(".zone.optional").length&&0==$(e.target).closest(".switch[rel]").length&&$(".zone.optional").slideUp()})}),gh.run("com.form",function(){$("input[type=hidden]").addClass("hidden"),$("input").not("[type=hidden]").addClass("input"),$(".radio").each(function(){var e=$(this),n=e.siblings(".radio");e.parent().children(".radio").first().addClass("first"),e.on("click",function(){n.removeClass("checked"),e.addClass("checked")})}),$(".topic .content img,.comment .content img").each(function(){var e=$(this);e.closest("p").addClass("img");var n="<a href='"+e.attr("src")+"' data-lightbox='one'></a>";e.wrap(n)});var e=function(){$(".input").each(function(){var e=$(this),n=e.closest(".body.main"),t=n.children("label,.label").first().width()||150,o=n.width()-t-50;e.width(o)})};e(),$(window).resize(function(){gh.log("window.resized"),e()}),$(".btn[api],.icon[api]").each(function(){var e=$(this);e.on("click",function(){return gh.runPostFlow(e)})})}),gh.run("com.debug",function(){if(gh.debug){var e=null,n="ws://127.0.0.1:9502";window.onload=function(){console.log("onload"),(e=new WebSocket(n)).onopen=function(){console.log("connected to "+n)},e.onclose=function(e){console.log("connection closed ("+e.code+")")},e.onmessage=function(e){console.log("message received: "+e.data),"reload"==e.data&&(location=location)}}}});
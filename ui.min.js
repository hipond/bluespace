gh={host:"",cdnPublicRoot:"",cdnImgRoot:"",uniqid:0,kvMap:{},regex:{}},gh.regex.username=/^[\w\u4e00-\u9fa5]{3,24}$/,gh.regex.email=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,gh.regex.password=/^\w{8,32}$/,gh.regex.title=/^.{1,256}$/,gh.fieldRuleMap={username:function(e){return gh.regex.username.test(e)?/(^\_)|(\__)|(\_+$)/.test(e)?"用户名首尾不能出现下划线'_'":/^\d+\d+\d$/.test(e)?"用户名不能全为数字":void 0:"用户名不能有特殊字符"},password:function(e){if(!gh.regex.password.test(e))return"密码必须8到24位数字或字母"},email:function(e){if(!gh.regex.email.test(e))return"邮箱格式有误"},logined:function(){if(!gh.logined)return gh.alert("请登录"),setTimeout(function(){location=gh.path("/passport/login?from=topic.comment")},800),!1}},gh.path=function(e){return/^http[s]*:\/\//i.test(e)?e:gh.host+e},gh.cdn=function(e){return gh.cdnPublicRoot+e},gh.alert=function(e,n,t,o){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future"};o=1==o||"success"==o?"success":"error";Messenger().post({message:e,type:o,showCloseButton:!1,id:"gh-alert",hideAfter:n||1.3,onClickClose:!0}),0<n&&setTimeout(function(){"string"!=typeof t?t():window.location=t},n)},gh.confirm=function(e,n){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future",id:"gh-confirm"};var t=Messenger().post({message:e,type:"error",actions:{confirm:{label:"确定",action:function(){return t.cancel(),n()}},cancel:{label:"取消",action:function(){return t.cancel()}}}})},gh.run=function(e,n){if(gh.runHub=gh.runHub||{},gh.runId=gh.runId||0,void 0!==e)id=++gh.runId,void 0===n&&(n=e,e=id),gh.runHub[id]={key:e,fn:n};else for(var t=0;t++<=gh.runId;)"object"==typeof gh.runHub[t]&&gh.runHub[t].fn()},gh.fn=function(e,n){return gh.fnHub=gh.fnHub||{},"function"==typeof n?gh.fnHub[e]=n:gh.fnHub[e](n)},gh.log=function(){gh.debug=gh.debug||!1,gh.debug&&console.log(arguments)},gh.data=function(e){var l="string"==typeof e?$(e):e,u={},d=0;if(l.find("input").not("[type=file]").each(function(){if(!d){var e=$(this),n=e.attr("name"),o=e.attr("title")||e.siblings("label").text()||e.attr("name"),i=e.val(),t=e.attr("required"),a=e.attr("exp"),r=e.attr("equal");if(t&&i.length<1)return gh.alert("请填写`"+o+"`"),d++;if(a){a=a.split("|");var c=!1,s=!1;if($.each(a,function(e,n){if(fn=gh.fieldRuleMap[n])(s=fn(i))||(c=!0);else{var t=gh.regex[n];t||gh.alert("规则配置异常："+o+":"+n),t.test(i)&&(c=!0)}}),!c)return gh.alert(s||"`"+o+"`格式有误"),d++}if(r)if((l.find("input[name="+r+"]").val()||null)!=i)return gh.alert("`"+o+"`不匹配"),d++;u[n]=i}}),!d&&(l.find(".radio.checked").each(function(){var e=$(this),n=e.attr("name");u[n]=e.val()||e.attr("value")}),l.find(".src").each(function(){var e=$(this),n=e.attr("name");u[n]=e.val()||e.attr("src")}),l.find(".textarea").each(function(){if(!d){var e=$(this),n=e.attr("name");if(void 0!==gh.editor){var t=gh.editor.txt.text(),o=gh.editor.txt.html();if(t.length<3)return gh.alert("内容字数过少，请完善内容"),d++;u[n]=o}else u[n]=e.val()}}),!d))return u},gh.post=function(e,n,t,o){$.post(gh.path(e),n,function(n){if(1===n.state){var e=n.data.timeout||e||1500;gh.alert(n.message,e,function(){var e=e||n.data.location;e&&"#"!=e&&("."==e&&(e=location),window.location=e)},"success")}else gh.alert(n.message)},"json")},gh.runPostFlow=function(i){if(i.hasClass("off"))return!1;function e(){var e=i.attr("api");e||gh.alert("error.btn.api");var n=i.hasClass("empty")?{}:gh.data(i.closest(".form")),t=i.attr("timeout")||1500,o=i.attr("redirect")||null;return n&&gh.post(e,n,t,o),!1}i.addClass("off"),setTimeout(function(){i.removeClass("off")},3e3);var n=i.attr("confirm");return n?gh.confirm(n,function(){e()}):e()},gh.load=function(e,n,t){return gh.loadMap=gh.loadMap||{},1===gh.loadMap[e]?n():(t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t).done(function(){return gh.loadMap[e]=1,n()}))},gh.fn("editor",function(t){gh.load("/wangEditor.min.js",function(){var e,n;e=t,n=window.wangEditor,gh.editor=new n(e.element),gh.editor.config.menus=["head","bold","fontName","italic","underline","strikeThrough","indent","foreColor","list","justify","quote","emoticon","image","table","code","splitLine","undo","redo"],gh.editor.config.fontNames=["黑体","仿宋","楷体","宋体","微软雅黑"],gh.editor.config.colors=["#ab2b2b","#069","#337d56","#9d5b8b","#dcb183","#f0f0f0","#000"],gh.editor.config.fontSizes={"x-small":{name:"10px",value:"1"},small:{name:"13px",value:"2"},normal:{name:"16px",value:"3"},large:{name:"18px",value:"4"},"x-large":{name:"24px",value:"5"},"xx-large":{name:"28px",value:"6"}},gh.editor.config.uploadImgServer=gh.cdnParams.bucket,gh.editor.config.uploadImgParams={policy:gh.cdnParams.policy,signature:gh.cdnParams.signature},gh.editor.config.uploadFileName="file",gh.editor.config.customAlert=function(e){gh.alert(e)},gh.editor.config.uploadImgHooks={success:function(e){console.log("success",e)},fail:function(e,n,t){console.log("fail",t)},error:function(e,n,t){console.log("error",e,t)},timeout:function(e){console.log("timeout")},customInsert:function(e,n){var t=gh.cdnImgRoot+n.url;e(t)}},gh.editor.create()})}),gh.fn("imageUploader",function(n){var t=$(n.element);t.after("<input class='upload image hide' type='file' name='file'/>");var o=t.next("input.upload.image");t.on("click",function(){o.click()}),o.on("change",function(){!function(){if(""==o.val())gh.log("fileInput:empty");else{var e=new FormData;e.append("signature",n.signature),e.append("policy",n.policy),e.append("file",o.get(0).files[0]),gh.log(e),$.ajax({url:n.url,data:e,type:"POST",async:!1,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){var n=gh.cdnImgRoot+e.url+"!content";t.attr("src",n)},error:function(e){gh.log(e)}})}}()})}),gh.run("com.common",function(){$(".zone.breadcrumb a").not(":first").before("|"),$("a[href=]").removeAttr("href"),$(".body.main").css({"min-height":$(window).height()-160}),$(".popup[inline]").each(function(){var e=$(this);e.hasClass("logined")&&!gh.logined||e.modaal({type:"inline",overlay_close:!1,content_source:e.attr("inline"),fullscreen:!!e.attr("fullscreen"),width:900<$(window).width()?800:null,close_text:"关闭"})}),$("img").error(function(){$(this).hide()}),"/"==location.pathname&&$(".zone.breadcrumb *").css({cursor:"auto"})}),gh.run("com.tab",function(){$(".tab").each(function(){var e=$(this),n=e.children(".head").first(),t=e.children(".content").first(),o=n.children(".key"),i=t.children(".item");o.each(function(){var e=$(this),n=e.index();e.on("click",function(){o.removeClass("focus"),e.addClass("focus"),i.removeClass("on"),i.eq(n).addClass("on")})})}),$(".switch[rel]").on("click",function(e){$(".zone.optional.region.menu .tab.province .content").css({"min-height":"auto"}),e.preventDefault();var n=$(this).attr("rel"),t=$(".zone.optional"),o=$(".zone.optional."+n);return t.not(o).hide(),o.slideToggle(),!1}),$(document).bind("click",function(e){0==$(e.target).closest(".zone.optional").length&&0==$(e.target).closest(".switch[rel]").length&&$(".zone.optional").slideUp()})}),gh.run("com.form",function(){$("input[type=hidden]").addClass("hidden"),$("input").not("[type=hidden]").addClass("input"),$(".radio").each(function(){var e=$(this),n=e.siblings(".radio");e.parent().children(".radio").first().addClass("first"),e.on("click",function(){n.removeClass("checked"),e.addClass("checked")})}),$(".topic .content img,.comment .content img").each(function(){var e=$(this);e.closest("p").addClass("img");var n="<a href='"+e.attr("src")+"' data-lightbox='one'></a>";e.wrap(n)});var e=function(){$(".input").each(function(){var e=$(this),n=e.closest(".body.main"),t=n.children("label,.label").first().width()||150,o=n.width()-t-50;e.width(o)}),$(window).width()<501?$("body").addClass("mob"):$("body").removeClass("mob")};e(),$(window).resize(function(){gh.log("window.resized"),e()}),$(".btn[api],.icon[api]").each(function(){var e=$(this);e.on("click",function(){return gh.runPostFlow(e)})})}),gh.run("com.debug",function(){if(gh.debug){var e=null,n="ws://127.0.0.1:9502";window.onload=function(){console.log("onload"),(e=new WebSocket(n)).onopen=function(){console.log("connected to "+n)},e.onclose=function(e){console.log("connection closed ("+e.code+")")},e.onmessage=function(e){console.log("message received: "+e.data),"reload"==e.data&&(location=location)}}}}),gh.run("AMap",function(){if(!($(".switch.amap").length<1)){$("body.gh").append('<div id="popupAMap" class="modal inline hide super"><div id="AMap"></div></div>'),$("#AMap").css({height:Math.max(Math.min($(window).height()-100,500),200)});var c=gh.cityName,s=null,n=0;$(".switch.amap").on("click",function(e){if(0<n)return!1;n=1,$.getScript("//webapi.amap.com/maps?v=2.0&key=7a691853c163226237988b482ce8ee6b").done(function(){map=new AMap.Map("AMap",{viewMode:"3D",zoom:12}),map.setCity(c),map.plugin(["AMap.ToolBar","AMap.Scale","AMap.DistrictSearch","AMap.Weather"],function(){map.addControl(new AMap.Scale),map.addControl(new AMap.ToolBar),new AMap.DistrictSearch({extensions:"all",level:"district"}).search(c,function(e,n){var t=n.districtList[0].boundaries;s=n.districtList[0].center,console.log(n.districtList[0]),console.log(s.pos);var o=[];if(t){for(var i=0,a=t.length;i<a;i++){var r=new AMap.Polygon({map:map,strokeWeight:1,path:t[i],fillOpacity:.1,fillColor:"#015f5a",strokeColor:"#BF0A2B"});o.push(r)}map.setFitView()}(new AMap.Weather).getLive(c,function(e,n){if(!e){var t=[];t.push("<h4 >实时天气</h4><hr>"),t.push("<div>城市/区："+n.city+"</div>"),t.push("<div>天气："+n.weather+"</div>"),t.push("<div>温度："+n.temperature+"℃</div>"),t.push("<div>风向："+n.windDirection+"</div>"),t.push("<div>风力："+n.windPower+" 级</div>"),t.push("<div>空气湿度："+n.humidity+"</div>"),t.push("<div>发布时间："+n.reportTime+"</div>");var o=new AMap.Marker({map:map,position:[s.lng,s.lat]}),i=new AMap.InfoWindow({content:'<div class="info amap">'+t.join("")+"</div>",isCustom:!0,offset:new AMap.Pixel(0,-37)});i.open(map,o.getPosition()),o.on("mouseover",function(){i.open(map,o.getPosition())})}})})})}).fail(function(){n=0})})}});
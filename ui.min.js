gh={host:"",cdnPublicRoot:"",cdnImgRoot:"",uniqid:0,kvMap:{},regex:{}},gh.regex.username=/^[\w\u4e00-\u9fa5]{3,24}$/,gh.regex.email=/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/,gh.regex.password=/^\w{8,32}$/,gh.regex.title=/^.{1,256}$/,gh.fieldRuleMap={username:function(e){return gh.regex.username.test(e)?/(^\_)|(\__)|(\_+$)/.test(e)?"用户名首尾不能出现下划线'_'":/^\d+\d+\d$/.test(e)?"用户名不能全为数字":void 0:"用户名不能有特殊字符"},password:function(e){if(!gh.regex.password.test(e))return"密码必须8到24位数字或字母"},email:function(e){if(!gh.regex.email.test(e))return"邮箱格式有误"},logined:function(){if(!gh.logined)return gh.alert("请登录"),setTimeout(function(){location=gh.path("/passport/login?from=topic.comment")},800),!1}},gh.path=function(e){return/^http[s]*:\/\//i.test(e)?e:gh.host+e},gh.cdn=function(e){return gh.cdnPublicRoot+e},gh.alert=function(e,t,n,o){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future"};o=1==o||"success"==o?"success":"error";Messenger().post({message:e,type:o,showCloseButton:!1,id:"gh-alert",hideAfter:t||1.3,onClickClose:!0}),0<t&&setTimeout(function(){"string"!=typeof n?n():window.location=n},t)},gh.confirm=function(e,t){Messenger.options={extraClasses:"messenger-fixed messenger-on-top",theme:"future",id:"gh-confirm"};var n=Messenger().post({message:e,type:"error",actions:{confirm:{label:"确定",action:function(){return n.cancel(),t()}},cancel:{label:"取消",action:function(){return n.cancel()}}}})},gh.run=function(e,t){if(gh.runHub=gh.runHub||{},gh.runId=gh.runId||0,void 0!==e)id=++gh.runId,void 0===t&&(t=e,e=id),gh.runHub[id]={key:e,fn:t};else for(var n=0;n++<=gh.runId;)"object"==typeof gh.runHub[n]&&gh.runHub[n].fn()},gh.fn=function(e,t){return gh.fnHub=gh.fnHub||{},"function"==typeof t?gh.fnHub[e]=t:gh.fnHub[e](t)},gh.log=function(){gh.debug=gh.debug||!1,gh.debug&&console.log(arguments)},gh.data=function(e){var l="string"==typeof e?$(e):e,d={},u=0;if(l.find("input").not("[type=file]").each(function(){if(!u){var e=$(this),t=e.attr("name"),o=e.attr("title")||e.siblings("label").text()||e.attr("name"),i=e.val(),n=e.attr("required"),a=e.attr("exp"),r=e.attr("equal");if(n&&i.length<1)return gh.alert("请填写`"+o+"`"),u++;if(a){a=a.split("|");var s=!1,c=!1;if($.each(a,function(e,t){if(fn=gh.fieldRuleMap[t])(c=fn(i))||(s=!0);else{var n=gh.regex[t];n||gh.alert("规则配置异常："+o+":"+t),n.test(i)&&(s=!0)}}),!s)return gh.alert(c||"`"+o+"`格式有误"),u++}if(r)if((l.find("input[name="+r+"]").val()||null)!=i)return gh.alert("`"+o+"`不匹配"),u++;d[t]=i}}),!u&&(l.find(".radio.checked").each(function(){var e=$(this),t=e.attr("name");d[t]=e.val()||e.attr("value")}),l.find(".src").each(function(){var e=$(this),t=e.attr("name");d[t]=e.val()||e.attr("src")}),l.find(".textarea").each(function(){if(!u){var e=$(this),t=e.attr("name");if(e.hasClass("editor")){var n=e.attr("editor")||null,o=tinymce.editors[n].getBody(),i=tinymce.editors[n].getContent();if(o.length<3)return gh.alert("内容字数过少，请完善内容"),u++;d[t]=i}else d[t]=e.val()}}),!u))return d},gh.post=function(e,t,n,o){$.post(gh.path(e),t,function(t){if(1===t.state){var e=t.data.timeout||e||1500;gh.alert(t.message,e,function(){var e=e||t.data.location;e&&"#"!=e&&("."==e&&(e=location),window.location=e)},"success")}else gh.alert(t.message)},"json")},gh.runPostFlow=function(i){if(i.hasClass("off"))return!1;function e(){var e=i.attr("api");e||gh.alert("error.btn.api");var t=i.hasClass("empty")?{}:gh.data(i.closest(".form")),n=i.attr("timeout")||1500,o=i.attr("redirect")||null;return t&&gh.post(e,t,n,o),!1}i.addClass("off"),setTimeout(function(){i.removeClass("off")},3e3);var t=i.attr("confirm");return t?gh.confirm(t,function(){e()}):e()},gh.load=function(e,t,n){return gh.loadMap=gh.loadMap||{},1===gh.loadMap[e]?t():(n=$.extend(n||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(n).done(function(){return gh.loadMap[e]=1,t()}))},gh.fn("editor",function(e){var n=$(e.element);if(gh.editorLoaded=gh.editorLoaded||0,gh.editorLoaded)return t(e);gh.editorLoaded=1;return void gh.load("https://cdn.tiny.cloud/1/0dom44h04ohxupelroqlw346m3ekk9nibnvjy04zz7m0t6ve/tinymce/5/tinymce.min.js",function(){gh.load("/tiny.zh_CN.js",function(){t(e)})});function t(e){tinymce.init({selector:e.element,language:"zh_CN",plugins:"code lists media table emoticons toc image hr imagetools advcode preview",toolbar:"undo redo cut copy paste pastetext  pagebreak emoticons hr forecolor toc blockquote styleselect bold italic alignleft aligncenter alignright bullist numlist table outdent indent image code preview",toolbar_mode:"floating",images_upload_handler:o});var t=gh.editorId||0;n.attr("editor",t++)}function o(e,t,n,o){var i,a;(i=new XMLHttpRequest).withCredentials=!1,i.open("POST",gh.cdnParams.url),i.upload.onprogress=function(e){o(e.loaded/e.total*100)},i.onload=function(){var e;403!==i.status?i.status<200||300<=i.status?n("HTTP Error: "+i.status):(e=JSON.parse(i.responseText))&&"string"==typeof e.url?t(gh.cdnImgRoot+e.url+"!content"):n("Invalid JSON: "+i.responseText):n("HTTP Error: "+i.status,{remove:!0})},i.onerror=function(){n("图片上传失败: "+i.status)},(a=new FormData).append("file",e.blob(),e.filename()),a.append("signature",gh.cdnParams.signature),a.append("policy",gh.cdnParams.policy),i.send(a)}}),gh.fn("imageUploader",function(t){var n=$(t.element);n.after("<input class='upload image hide' type='file' name='file'/>");var o=n.next("input.upload.image");n.on("click",function(){o.click()}),o.on("change",function(){!function(){if(""==o.val())gh.log("fileInput:empty");else{var e=new FormData;e.append("signature",t.signature),e.append("policy",t.policy),e.append("file",o.get(0).files[0]),gh.log(e),$.ajax({url:t.url,data:e,type:"POST",async:!1,cache:!1,contentType:!1,processData:!1,dataType:"json",success:function(e){var t=gh.cdnImgRoot+e.url+"!content";n.attr("src",t)},error:function(e){gh.log(e)}})}}()})}),gh.run("com.common",function(){$(".zone.breadcrumb a").not(":first").before("|"),$("a[href=]").removeAttr("href"),$(".body.main").css({"min-height":$(window).height()-160}),$(".super").each(function(){$(this).appendTo("body")}),$(".popup[inline]").each(function(){var e=$(this);e.hasClass("logined")&&!gh.logined||e.modaal({type:"inline",overlay_close:!1,content_source:e.attr("inline"),fullscreen:!!e.attr("fullscreen"),width:700<$(window).width()?700:null,close_text:"关闭"})}),$("img").error(function(){$(this).hide()}),"/"==location.pathname&&$(".zone.breadcrumb *").css({cursor:"auto"})}),gh.run("com.tab",function(){$(".tab").each(function(){var e=$(this),t=e.children(".head").first(),n=e.children(".content").first(),o=t.children(".key"),i=n.children(".item");o.each(function(){var e=$(this),t=e.index();e.on("click",function(){o.removeClass("focus"),e.addClass("focus"),i.removeClass("on"),i.eq(t).addClass("on")})})}),$(".switch[rel]").on("click",function(e){$(".zone.optional.region.menu .tab.province .content").css({"min-height":"auto"}),e.preventDefault();var t=$(this).attr("rel"),n=$(".zone.optional"),o=$(".zone.optional."+t);return n.not(o).hide(),o.slideToggle(),!1}),$(document).bind("click",function(e){0==$(e.target).closest(".zone.optional").length&&0==$(e.target).closest(".switch[rel]").length&&$(".zone.optional").slideUp()})}),gh.run("com.form",function(){$("input[type=hidden]").addClass("hidden"),$("input").not("[type=hidden]").addClass("input"),$(".radio").each(function(){var e=$(this),t=e.siblings(".radio");e.parent().children(".radio").first().addClass("first"),e.on("click",function(){t.removeClass("checked"),e.addClass("checked")})}),$(".topic .content img,.comment .content img").each(function(){var e=$(this);e.closest("p").addClass("img");var t="<a href='"+e.attr("src")+"' data-lightbox='one'></a>";e.wrap(t)});var e=function(){$(".input").each(function(){var e=$(this),t=e.closest(".body.main"),n=t.children("label,.label").first().width()||150,o=t.width()-n-50;e.width(o)}),$(window).width()<501?$("body").addClass("mob"):$("body").removeClass("mob")};e(),$(window).resize(function(){gh.log("window.resized"),e()}),$(".btn[api],.icon[api]").each(function(){var e=$(this);e.on("click",function(){return gh.runPostFlow(e)})})}),gh.run("com.debug",function(){if(gh.debug){var e=null,t="ws://127.0.0.1:9502";window.onload=function(){console.log("onload"),(e=new WebSocket(t)).onopen=function(){console.log("connected to "+t)},e.onclose=function(e){console.log("connection closed ("+e.code+")")},e.onmessage=function(e){console.log("message received: "+e.data),"reload"==e.data&&(location=location)}}}}),gh.run("AMap",function(){if(!($(".switch.amap").length<1)){$("body.gh").append('<div id="popupAMap" class="modal inline hide super"><div id="AMap"></div></div>'),$("#AMap").css({height:Math.max(Math.min($(window).height()-100,500),200)});var s=gh.cityName,c=null,t=0;$(".switch.amap").on("click",function(e){if(0<t)return!1;t=1,$.getScript("//webapi.amap.com/maps?v=2.0&key=7a691853c163226237988b482ce8ee6b").done(function(){map=new AMap.Map("AMap",{viewMode:"3D",zoom:12}),map.setCity(s),map.plugin(["AMap.ToolBar","AMap.Scale","AMap.DistrictSearch","AMap.Weather"],function(){map.addControl(new AMap.Scale),map.addControl(new AMap.ToolBar),new AMap.DistrictSearch({extensions:"all",level:"district"}).search(s,function(e,t){var n=t.districtList[0].boundaries;c=t.districtList[0].center,console.log(t.districtList[0]),console.log(c.pos);var o=[];if(n){for(var i=0,a=n.length;i<a;i++){var r=new AMap.Polygon({map:map,strokeWeight:1,path:n[i],fillOpacity:.1,fillColor:"#015f5a",strokeColor:"#BF0A2B"});o.push(r)}map.setFitView()}(new AMap.Weather).getLive(s,function(e,t){if(!e){var n=[];n.push("<h4 >实时天气</h4><hr>"),n.push("<div>城市/区："+t.city+"</div>"),n.push("<div>天气："+t.weather+"</div>"),n.push("<div>温度："+t.temperature+"℃</div>"),n.push("<div>风向："+t.windDirection+"</div>"),n.push("<div>风力："+t.windPower+" 级</div>"),n.push("<div>空气湿度："+t.humidity+"</div>"),n.push("<div>发布时间："+t.reportTime+"</div>");var o=new AMap.Marker({map:map,position:[c.lng,c.lat]}),i=new AMap.InfoWindow({content:'<div class="info amap">'+n.join("")+"</div>",isCustom:!0,offset:new AMap.Pixel(0,-37)});i.open(map,o.getPosition()),o.on("mouseover",function(){i.open(map,o.getPosition())})}})})})}).fail(function(){t=0})})}});